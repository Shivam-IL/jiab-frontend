substitutions:
  _REGION: asia-south1
  _PROJECT_ID: ai0015455-sfa-test
  _SERVICE_NAME: tccc-sfa-test-cloudrun-front-end
  _REPO_NAME: ccc-sfa-test-cloudrun-main-backend
  _IMAGE_NAME: frontend-app
  _VPC_NAME: tccc-sfa-test-vpc
  _SUBNET_NAME: tccc-sfa-test-subnet

steps:
  # Step 1: Build Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - build
      - '-t'
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:$SHORT_SHA'
      - '.'

  # Step 2: Push image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - push
      - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:$SHORT_SHA'

  # Step 3: Fetch secrets & deploy to Cloud Run 2nd Gen
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - -c
      - |
        echo "Fetching secrets from Secret Manager..."
        ENV_VARS=""
        for key in \
          NEXT_PUBLIC_API_URL \
          NEXT_PUBLIC_STRAPI_API_URL \
          NEXT_PUBLIC_GLUEDIN_API_KEY \
          NEXT_PUBLIC_GLUEDIN_SECRET_KEY \
          NEXT_PUBLIC_SECRET_KEY \
          NEXT_PUBLIC_GA_ID \
          NEXT_PUBLIC_FIREBASE_API_KEY \
          NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN \
          NEXT_PUBLIC_FIREBASE_PROJECT_ID \
          NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET \
          NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID \
          NEXT_PUBLIC_FIREBASE_APP_ID \
          NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID \
          NEXT_PUBLIC_FIREBASE_VAPID_KEY \
          NEXT_PUBLIC_INFOBIP_WHATSAPP_URL \
          NEXT_PUBLIC_CDP_CLIENT_ID \
          NEXT_PUBLIC_CDP_BRAND_NAME \
          NEXT_PUBLIC_CDP_API_URL \
          NEXT_PUBLIC_CDP_API_KEY \
          NEXT_PUBLIC_CDP_USER_IDENTIFIED_TYPE \
          NEXT_PUBLIC_CDP_USER_IDENTIFIER_SUB_TYPE \
          NEXT_PUBLIC_IP_URL; do
            value=$(gcloud secrets versions access latest --secret=$key)
            ENV_VARS+="${key}=${value},"
        done
        ENV_VARS=${ENV_VARS::-1}  # Trim trailing comma

        echo "Deploying to Cloud Run (2nd Gen)..."
        gcloud run deploy ${_SERVICE_NAME} \
          --image=${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:$SHORT_SHA \
          --region=${_REGION} \
          --platform=managed \
          --execution-environment=gen2 \
          --vpc-egress=all \
          --network=projects/${_PROJECT_ID}/global/networks/${_VPC_NAME} \
          --subnet=${_SUBNET_NAME} \
          --allow-unauthenticated \
          --cpu=1 \
          --memory=512Mi \
          --min-instances=1 \
          --max-instances=3 \
          --set-env-vars=$ENV_VARS

images:
  - '${_REGION}-docker.pkg.dev/${_PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:$SHORT_SHA'

timeout: 1200s

options:
  logging: CLOUD_LOGGING_ONLY
