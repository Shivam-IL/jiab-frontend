steps:
  # Step 1: Build Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'build',
        '-f',
        'Dockerfile.dev',
        '-t',
        'asia-south1-docker.pkg.dev/ai0015455-sfa-test/tccc-sfa-test-cloud-build-repo/tccc-sfa-test-cloudrun-main-backend:latest',
        '.'
      ]

  # Step 2: Push image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'push',
        'asia-south1-docker.pkg.dev/ai0015455-sfa-test/tccc-sfa-test-cloud-build-repo/tccc-sfa-test-cloudrun-main-backend:latest'
      ]

  # Step 3: Deploy to Cloud Run with secrets
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args:
      [
        'run',
        'deploy',
        'tccc-sfa-test-cloudrun-main-backend',
        '--image=asia-south1-docker.pkg.dev/ai0015455-sfa-test/tccc-sfa-test-cloud-build-repo/tccc-sfa-test-cloudrun-main-backend:latest',
        '--region=asia-south1',
        '--platform=managed',
        '--execution-environment=gen2',
        '--allow-unauthenticated',
        '--service-account=tccc-sfa-test-cloudrun-sa@ai0015455-sfa-test.iam.gserviceaccount.com',
        '--vpc-egress=all',
        '--min-instances=1',
        '--max-instances=3',
        '--cpu=1',
        '--memory=512Mi',
        '--set-secrets=APP_ENV=APP_ENV:latest,INFOBIP_BASE_URL=INFOBIP_BASE_URL:latest,INFOBIP_API_KEY=INFOBIP_API_KEY:latest,JWT_SECRET_KEY=JWT_SECRET_KEY:latest,JWT_ACCESS_TOKEN_EXPIRY=JWT_ACCESS_TOKEN_EXPIRY:latest,JWT_REFRESH_TOKEN_EXPIRY=JWT_REFRESH_TOKEN_EXPIRY:latest,JWT_TEMP_TOKEN_EXPIRY=JWT_TEMP_TOKEN_EXPIRY:latest,USE_SSH=USE_SSH:latest,DB_HOST=DB_HOST:latest,DB_PORT=DB_PORT:latest,DB_USER=DB_USER:latest,DB_PASSWORD=DB_PASSWORD:latest,DB_NAME=DB_NAME:latest,DB_SSL_MODE=DB_SSL_MODE:latest,GLUEDIN_BASE_URL=GLUEDIN_BASE_URL:latest,GLUEDIN_API_KEY=GLUEDIN_API_KEY:latest,FIREBASE_SERVICE_KEY_PATH=FIREBASE_SERVICE_KEY_PATH:latest,MIXCODE_BASE_URL=MIXCODE_BASE_URL:latest,MIXCODE_PROGRAM_ID=MIXCODE_PROGRAM_ID:latest,MIXCODE_PROGRAM_SECRET=MIXCODE_PROGRAM_SECRET:latest,GOOGLE_PUBSUB_PROJECT_ID=GOOGLE_PUBSUB_PROJECT_ID:latest,GOOGLE_PUBSUB_SUBSCRIPTION_ID=GOOGLE_PUBSUB_SUBSCRIPTION_ID:latest,GOOGLE_PUBSUB_TOPIC_ID=GOOGLE_PUBSUB_TOPIC_ID:latest,GOOGLE_PUBSUB_CREDENTIALS_PATH=GOOGLE_PUBSUB_CREDENTIALS_PATH:latest'
      ]

images:
  - asia-south1-docker.pkg.dev/ai0015455-sfa-test/tccc-sfa-test-cloud-build-repo/tccc-sfa-test-cloudrun-main-backend:latest

options:
  logging: CLOUD_LOGGING_ONLY
